---
name: 删除调试用户使用微信原生登录
overview: 删除 api.ts 中的调试用户(mockUser)逻辑，改为使用微信原生登录方式获取真实用户信息。
todos:
  - id: remove-mock-user
    content: 删除 api.ts 中的 mockUser 调试用户逻辑
    status: completed
  - id: add-wx-login
    content: 添加微信 getUserProfile 获取用户信息方法
    status: completed
    dependencies:
      - remove-mock-user
  - id: update-login-flow
    content: 修改登录流程，整合用户信息获取
    status: completed
    dependencies:
      - add-wx-login
  - id: add-user-sync
    content: 添加用户信息同步到云端功能
    status: completed
    dependencies:
      - update-login-flow
---

## 需求分析

用户要求删除调试用户，使用微信原生登录方式获取真实用户信息。

### 当前问题

1. `src/utils/api.ts` 中的 `getUserInfo` 函数在本地存储为空时会创建一个 mockUser（调试用户）
2. 需要改为使用微信原生登录获取真实用户信息（头像、昵称等）

### 核心功能

- 删除 api.ts 中的 mockUser 调试用户逻辑
- 添加微信原生登录获取用户信息的方式（getUserProfile 或 getUserInfo）
- 将获取到的用户信息与云开发登录结合
- 用户信息持久化存储

## 技术方案

### 实现思路

由于微信小程序 `getUserProfile` 和 `getUserInfo` 接口已调整，需要用户主动触发才能获取用户信息。方案如下：

1. **登录流程**：

- 使用 `wx.login` 获取 code，调用云函数换取 openid（已实现）
- 首次登录时，引导用户点击按钮授权获取用户信息
- 使用 `uni.getUserProfile` 获取用户头像、昵称等信息
- 将用户信息保存到本地存储和云数据库

2. **用户信息获取**：

- 优先从本地存储读取
- 如果没有用户信息，返回 null 并引导授权
- 提供 `updateUserInfo` 方法更新用户信息

3. **数据存储**：

- 本地：`uni.getStorageSync` 缓存用户信息
- 云端：通过云函数保存到云数据库（可选）

### 关键改动

- 修改 `api.ts` 中的 `getUserInfo`，删除 mockUser 逻辑
- 新增 `getWxUserProfile` 方法获取微信用户信息
- 新增 `syncUserToCloud` 方法同步用户数据到云端
- 修改登录流程，在获取 openid 后引导用户授权

### 目录结构

```
src/
├── utils/
│   ├── api.ts          # [MODIFY] 删除mockUser，添加微信原生登录
│   └── cloudbase.ts    # [MODIFY] 导出userToken，添加用户信息同步
```