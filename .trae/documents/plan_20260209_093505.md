# 多级分销系统“阶级跃迁”晋升机制设计方案

## 1. 现状分析与问题诊断
当前代码（`cloudfunctions/promotion/index.js`）实现的是**基于固定层级（物理位置）的返佣逻辑**：
- **机制**：严格按照邀请关系链向上追溯 4 级（20%-15%-10%-5%）。
- **痛点**：
  - **位置固化**：用户所在的“第几级”完全由谁邀请决定，能力再强也无法改变物理层级（例如 Level 4 永远是 Level 4）。
  - **收益断层**：只能吃到下级 4 层以内的收益。如果您的团队裂变到了第 10 层，作为 Level 4 的“老祖宗”完全拿不到第 5-10 层的收益，导致“有能力但无法躺赚”。

## 2. 解决方案：引入“身份等级（Rank）”双轨制
为了实现“阶级跃迁”和“躺赚”，建议在现有**分销层级（Genealogy）** 之外，新增一套**身份等级（Performance Rank）** 系统。

### 核心概念：双轨驱动
1.  **分销层级（维持现状）**：保持现有的 4 级返佣（20/15/10/5%），作为**基础推广奖励**，激励用户去拉新。
2.  **身份等级（新增机制）**：引入“级差分红”机制，解决“无限层级”和“晋升”问题。

### 详细设计

#### A. 等级划分（阶级定义）
设定 3-5 个能力等级，例如：
- **L0 普通代理**（默认）：无特殊权益。
- **L1 核心代理**（青铜）：团队总业绩达 1万 或 直推 10 人。
- **L2 高级合伙人**（白银）：团队总业绩达 10万 或 培养 3 个 L1。
- **L3 联创合伙人**（黄金）：团队总业绩达 50万 或 培养 3 个 L2。

#### B. 权益设计（躺赚机制）
新增**团队级差奖（Team Differential Bonus）**：
每个等级对应一个**全局分红比例**（例如：L1=2%, L2=5%, L3=8%）。

**计算逻辑**：
当一笔订单产生时，除了发放原有的 4 级分销佣金外，额外拿出一笔钱（如利润的 10%）作为**等级奖金池**，向上寻找有等级的上级：
- **场景**：你（L3，8%） -> 下级A（L1，2%） -> 下级B（普通，0%） -> **买家**
- **分润过程**：
  1.  **下级B**：无等级，不拿级差奖。
  2.  **下级A**：等级 L1（2%）。拿走 `订单金额 * 2%`。
  3.  **你（L3）**：等级 L3（8%）。因为下级 A 已经拿走了 2%，你拿**级差**：`8% - 2% = 6%`。
- **收益**：你拿到了 `订单金额 * 6%`。
- **特点**：
  - **无限穿透**：只要你的等级比下级高，无论这条线延伸到第 100 层，你都能拿到级差收益（8% - 下级的等级比例）。
  - **躺赚**：这就是你想要的“躺赚”模式，只要团队做大，整个团队的流水都与你有关。

#### C. 跃迁机制（晋升通道）
用户可以通过努力（刷业绩、拉人头）从普通代理晋升为 L3 合伙人，即使他物理上处于 Level 4，他的**身份等级**可以是最高的，享受全团队收益。

## 3. 技术实施方案（暂不修改，仅讨论）

若您确认采纳上述方案，后续我们将进行以下改造：

### 1. 数据库模型扩展 (`src/types/index.ts`)
- **User/PromotionUser 表**：
  - 新增 `rank` (当前等级: 0, 1, 2...)
  - 新增 `teamPerformance` (团队累计业绩，用于判断晋升)
  - 新增 `directInviteCount` (直推人数)

### 2. 云函数逻辑升级 (`cloudfunctions/promotion`)
- **监听订单完成**：当订单结算时，触发 `updateTeamPerformance`，更新整条邀请链上所有人的“团队业绩”。
- **自动晋升逻辑**：在更新业绩时，判断是否达到下一级门槛，若达到则自动升级 `rank`。
- **新增级差奖结算**：在 `calculatePromotionReward` 中，增加第二轮循环，计算并发放“级差奖”。

### 3. 前端展示 (`src/pages/promotion`)
- **推广中心**：展示当前等级、下一级晋升进度条（还差多少业绩升级）。
- **收益明细**：区分“推广佣金”（4级内）和“团队分红”（无限层级）。

---

**您觉得这个“级差分红 + 身份晋升”的方案是否符合您对“阶级跃迁”和“共赢”的构想？**
如果确认，我们可以开始着手规划具体的等级数值和代码调整。