## 部署方案：全面切换至原生云开发模式

我们将把项目从 HTTP 触发模式迁移到微信小程序原生云开发模式 (`wx.cloud`)，以获得更高的安全性和性能。

### 1. 后端改造 (云函数)

需要更新 `login` 云函数以支持原生调用，不再依赖 HTTP 请求中的 `code` 换取 OpenID，而是直接利用云端上下文 (`wxContext`)。

*   **修改 `cloudfunctions/login/index.js`**:
    *   新增/优化登录逻辑：当检测到原生云端上下文 (`wxContext.OPENID`) 时，直接使用该 OpenID 进行用户登录/注册流程，跳过 `jscode2session` 步骤。
*   **部署所有云函数**:
    *   将所有云函数 (`login`, `user`, `coupon`, `wallet`, `promotion`, `rewardSettlement`, `initData`, `hello`) 重新部署到环境 `cloud1-6gmp2q0y3171c353`。

### 2. 前端改造 (小程序端)

*   **重构 `src/utils/cloudbase.ts`**:
    *   **移除** `CLOUD_FUNCTION_URLS` 和 HTTP 请求逻辑 (`uni.request`)。
    *   **引入** `wx.cloud.init` 进行环境初始化。
    *   **重写** `callFunction`：使用 `wx.cloud.callFunction` 替代 HTTP 请求。
    *   **重写** `checkLogin`：直接调用改造后的 `login` 云函数进行静默登录。

### 3. 数据库验证
*   再次确认所有必要的数据库集合已存在且索引配置正确。

### 4. 验证与测试
*   执行一次完整的登录流程，验证是否能成功获取 OpenID 并创建/更新用户记录。
*   验证 API 调用是否正常（如获取用户信息、商品列表等）。

此方案将消除对 HTTP 触发器域名的依赖，简化鉴权流程，并解决跨域或 Token 管理等潜在问题。