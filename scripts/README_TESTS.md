# 分销系统测试脚本使用指南

## 📋 目录结构

```
scripts/
├── config.js                    # 测试配置（佣金比例、晋升门槛等）
├── calculation-engine.js        # 奖励计算引擎（独立函数）
├── test-promotion-core.js       # 核心佣金计算测试
├── test-e2e-flow.js            # 端到端流程测试
├── TEST_REPORT.md              # 测试报告
└── README_TESTS.md             # 本文档
```

---

## 🚀 快速开始

### 安装依赖

无需额外依赖，使用Node.js内置模块即可运行测试。

### 运行测试

```bash
# 运行核心佣金计算测试
node scripts/test-promotion-core.js

# 运行端到端流程测试
node scripts/test-e2e-flow.js
```

---

## 📊 测试场景说明

### 核心佣金计算测试 (test-promotion-core.js)

#### 场景 1: 完整的4级代理链 - 基础佣金分配

**测试内容**: 验证基础佣金按代理层级正确分配

**输入**:
- 订单金额: 100元
- 代理链: 4级 → 3级 → 2级 → 1级

**预期输出**:
- 四级代理: 1元 (1%)
- 三级代理: 3元 (3%)
- 二级代理: 6元 (6%)
- 一级代理: 10元 (10%)
- **总计: 20元**

---

#### 场景 2: 复购奖励 - 铜牌/银牌推广员

**测试内容**: 验证星级≥1的上级获得复购奖励

**输入**:
- 订单金额: 100元
- 是否复购: 是
- 上级星级: 1, 2, 0, 2

**预期输出**:
- 星级1: 3元 (3%)
- 星级2: 3元 (3%)
- 星级0: 0元 (不满足条件)
- 星级2: 3元 (3%)

---

#### 场景 3: 团队管理奖 - 级差算法

**测试内容**: 验证第一个星级≥2的上级获得全部管理奖

**输入**:
- 订单金额: 100元
- 上级星级: 2, 2, 1, 2

**预期输出**:
- 第一个星级2: 2元 (2%)
- 其他星级2: 0元 (已被分配)

**⚠️ 注意**: 这是"先到先得"的级差算法，可能需要业务确认

---

#### 场景 4: 综合场景 - 四重分润同时计算

**测试内容**: 验证基础佣金+复购+管理奖+育成津贴同时计算

**输入**:
- 订单金额: 100元
- 是否复购: 是
- agent1(4级,星1,导师=agent4)
- agent2(3级,星2)
- agent3(2级,星0)
- agent4(1级,星2)

**预期输出**:
- agent1: 1 + 3 = 4元
- agent2: 3 + 3 + 2 = 8元
- agent3: 6元
- agent4: 10 + 3 + 2 = 15元 (育成津贴)
- **总计: 33元 (33%)**

---

#### 场景 5: 晋升逻辑 - 铜牌晋升

**测试内容**: 验证铜牌晋升条件（累计销售额 OR 直推人数）

**场景 5.1**: 累计销售额达标
- 晋升前: 19,000元
- 完成订单: 1,000元
- 晋升后: 20,000元 ✅ 晋升成功

**场景 5.2**: 直推人数达标
- 晋升前: 29人
- 推荐用户: 1人
- 晋升后: 30人 ✅ 晋升成功

---

#### 场景 6: 跨月业绩重置

**测试内容**: 验证月度业绩自动重置逻辑

**输入**:
- 1月业绩: monthSales=50,000, totalSales=100,000
- 2月订单: 2,000元

**预期输出**:
- monthTag: "2026-02" ✅
- monthSales: 2,000元 ✅ (重置)
- totalSales: 102,000元 ✅ (累加)
- starLevel: 保持不变 ✅ (不降级)

---

### 端到端流程测试 (test-e2e-flow.js)

#### 场景 1: 新用户注册到首次购买

**测试流程**:
1. 创建代理链（一级→二级→三级）
2. 新用户扫描邀请码注册
3. 用户下单（100元）
4. 系统自动结算奖励

**验证点**:
- ✅ 基础佣金分配正确
- ✅ 业绩自动更新
- ✅ 推广关系建立成功

---

#### 场景 2: 团队扩张和晋升

**测试流程**:
1. 创建铜牌代理（29个直推）
2. 新用户注册（第30个直推）
3. 用户下单（500元）
4. 验证晋升条件

**验证点**:
- ✅ 直推人数累加
- ✅ 累计销售额更新
- ✅ 晋升条件判断正确

---

#### 场景 3: 跨月业绩重置

**测试流程**:
1. 创建银牌代理（1月业绩50,000元）
2. 1月31日完成订单（1,000元）
3. 2月1日完成订单（2,000元）
4. 验证跨月重置

**验证点**:
- ✅ 月份标签更新
- ✅ 本月销售额重置
- ✅ 累计销售额累加
- ✅ 星级保持不变

---

## 🔧 配置说明

### 佣金比例配置 (config.js)

```javascript
commission: {
  basic: {
    level1: 10,  // 一级代理: 10%
    level2: 6,   // 二级代理: 6%
    level3: 3,   // 三级代理: 3%
    level4: 1,   // 四级代理: 1%
    total: 20    // 总佣金: 20%
  },
  repurchase: {
    rate: 3,             // 复购奖励: 3%
    minStarLevel: 1      // 最低星级: 1
  },
  management: {
    rate: 2,             // 管理奖: 2%
    minStarLevel: 2,     // 最低星级: 2
    type: 'level-difference'  // 分配类型: 级差
  },
  nurture: {
    rate: 2,             // 育成津贴: 2%
    minStarLevel: 2      // 最低星级: 2
  }
}
```

### 晋升门槛配置 (config.js)

```javascript
promotion: {
  bronze: {
    starLevel: 1,
    totalSales: 2000000,  // 20,000元 (单位: 分)
    directCount: 30       // 30人 (OR条件)
  },
  silver: {
    starLevel: 2,
    monthSales: 5000000,  // 50,000元 (本月销售)
    teamCount: 100        // 100人 (AND条件)
  },
  gold: {
    starLevel: 3,
    monthSales: 20000000, // 200,000元
    teamCount: 500        // 500人
  }
}
```

---

## 📈 计算引擎API

### calculateAllRewards()

计算单个订单的所有奖励。

**参数**:
```javascript
{
  amount: number,      // 订单金额（分）
  superiors: Array,    // 上级列表
  isRepurchase: boolean // 是否复购
}
```

**上级列表格式**:
```javascript
[
  {
    userId: string,     // 用户ID
    agentLevel: number, // 代理层级 (1-4)
    starLevel: number,  // 星级 (0-3)
    mentorId: string    // 导师ID (可选)
  }
]
```

**返回值**:
```javascript
[
  {
    type: string,       // 奖励类型: basic|repurchase|management|nurture
    userId: string,     // 用户ID
    amount: number,     // 奖励金额（分）
    rate: number,       // 佣金比例
    starLevel: number,  // 星级
    menteeId: string    // 下级ID (仅育成津贴)
  }
]
```

---

### checkPromotion()

检查是否满足晋升条件。

**参数**:
```javascript
{
  totalSales: number,   // 累计销售额（分）
  monthSales: number,   // 本月销售额（分）
  directCount: number,  // 直推人数
  teamCount: number     // 团队人数
}
```

**返回值**:
```javascript
{
  shouldPromote: boolean,  // 是否晋升
  newStarLevel: number,    // 新星级
  reason: string           // 晋升原因
}
```

---

### checkAndResetMonthlyPerformance()

检查并重置月度业绩。

**参数**:
```javascript
{
  monthTag: string,    // 当前月份标签 "YYYY-MM"
  monthSales: number,  // 本月销售额（分）
  totalSales: number   // 累计销售额（分）
}
```

**返回值**:
```javascript
{
  monthTag: string,    // 新月份标签
  monthSales: number,  // 新本月销售额
  totalSales: number,  // 新累计销售额
  reset: boolean       // 是否触发重置
}
```

---

## 🐛 已知问题和限制

### E2E测试的限制

1. **代理层级计算偏差**
   - 问题: `getSuperiors()` 函数的 `agentLevel` 计算逻辑需要修正
   - 影响: E2E测试中的基础佣金分配不正确
   - 修复: 需要调整 `agentLevel` 计算公式

2. **业绩更新场景不完整**
   - 问题: 部分测试场景没有触发业绩更新
   - 影响: 无法完整验证业绩累加逻辑
   - 修复: 需要为测试订单添加代理关系

### 计算引擎的假设

1. **导师信息获取**
   - 假设: 导师在 `superiors` 数组中，或默认星级2
   - 实际: 云函数需要从数据库查询导师信息

2. **并发订单处理**
   - 假设: 单线程处理，无并发问题
   - 实际: 云函数可能存在竞争条件（已知问题）

3. **数据查询性能**
   - 假设: 内存操作，无性能问题
   - 实际: 云函数需要数据库查询，可能存在性能问题

---

## 🔍 下一步测试建议

### 高优先级

1. **修复E2E测试**
   - 修正代理层级计算逻辑
   - 完善业绩更新测试场景

2. **云函数集成测试**
   - 使用真实云函数和数据库
   - 验证计算引擎与云函数的一致性

3. **并发订单测试**
   - 模拟多笔订单同时完成
   - 验证业绩更新的竞争条件

### 中优先级

4. **边界情况测试**
   - 零金额订单
   - 超长代理链（>4级）
   - 孤儿用户（上级被删除）

5. **性能测试**
   - 大量订单并发结算
   - 团队统计查询性能

6. **防刷机制测试**
   - IP注册限制
   - 时间窗口验证

---

## 📞 联系方式

如有问题或建议，请联系开发团队。

---

## 📄 许可证

本测试脚本属于大友元气精酿啤酒小程序项目的一部分。
