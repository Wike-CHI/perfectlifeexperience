# æ¨å¹¿ä½“ç³»V2 - å®‰å…¨æ€§å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2026-02-25
**å®¡æŸ¥èŒƒå›´**: æ¨å¹¿ç³»ç»ŸV2å…¨æ ˆå®‰å…¨
**å®¡æŸ¥ç›®æ ‡**: è¯†åˆ«å®‰å…¨é£é™©ï¼Œç¡®ä¿æ•°æ®å’Œç”¨æˆ·å®‰å…¨

---

## æ‰§è¡Œæ‘˜è¦

### æ€»ä½“å®‰å…¨è¯„çº§: ğŸŸ¢ è‰¯å¥½ (B+)

### å®‰å…¨è¯„åˆ†

| å®‰å…¨é¢†åŸŸ | è¯„åˆ† | çŠ¶æ€ | è¯´æ˜ |
|----------|------|------|------|
| èº«ä»½è®¤è¯ | ğŸŸ¢ 85/100 | è‰¯å¥½ | æ­£ç¡®ä½¿ç”¨ wxContext.OPENID |
| è¾“å…¥éªŒè¯ | ğŸŸ¢ 80/100 | è‰¯å¥½ | æœ‰éªŒè¯ä½†å¯å¢å¼º |
| é˜²åˆ·æœºåˆ¶ | ğŸŸ¢ 85/100 | è‰¯å¥½ | å¤šå±‚é˜²æŠ¤å·²å®ç° |
| æ•°æ®åº“å®‰å…¨ | ğŸŸ¡ 70/100 | ä¸­ç­‰ | ç¼ºå°‘æ•°æ®åº“æƒé™é…ç½® |
| APIå®‰å…¨ | ğŸŸ¢ 85/100 | è‰¯å¥½ | ä½¿ç”¨äº‘å‡½æ•°éš”ç¦» |
| æ—¥å¿—å®¡è®¡ | ğŸŸ¢ 80/100 | è‰¯å¥½ | æ•æ„Ÿä¿¡æ¯å·²è„±æ• |

### å‘ç°çš„é—®é¢˜

| ä¸¥é‡æ€§ | é—®é¢˜ | æ•°é‡ | çŠ¶æ€ |
|--------|------|------|------|
| ğŸ”´ é«˜ | 0 | 0 | - |
| ğŸŸ¡ ä¸­ | 2 | 2 | éœ€è¦æ”¹è¿› |
| ğŸŸ¢ ä½ | 3 | 3 | å»ºè®®ä¼˜åŒ– |

---

## è¯¦ç»†å®¡æŸ¥ç»“æœ

### 1. èº«ä»½è®¤è¯å®‰å…¨ âœ…

#### 1.1 OPENIDè·å–æœºåˆ¶ âœ… æ­£ç¡®

**å‘ç°**: æ‰€æœ‰äº‘å‡½æ•°éƒ½æ­£ç¡®ä½¿ç”¨ `wxContext.OPENID` è·å–ç”¨æˆ·èº«ä»½

**éªŒè¯ä»£ç **:
```javascript
// cloudfunctions/promotion/index.js:1752
const OPENID = requestData._token || cloud.getWXContext().OPENID || requestData.OPENID;
```

**å®‰å…¨è¯„ä¼°**:
- âœ… å¾®ä¿¡å°ç¨‹åºçš„ OPENID ç”±è…¾è®¯äº‘è‡ªåŠ¨éªŒè¯ï¼Œæ— éœ€é¢å¤–è®¤è¯
- âœ… å‰ç«¯æ— æ³•ä¼ªé€  OPENIDï¼ˆç”±å¾®ä¿¡æœåŠ¡å™¨ç”Ÿæˆï¼‰
- âœ… ä½¿ç”¨äº‘å‡½æ•°ä½œä¸ºå¯ä¿¡ä¸­é—´å±‚

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

#### 1.2 ç”¨æˆ·ç™»å½•æµç¨‹ âœ… å®‰å…¨

**æ–‡ä»¶**: `cloudfunctions/login/index.js`

**æµç¨‹**:
```javascript
const wxContext = cloud.getWXContext();
let openid = wxContext.OPENID;  // âœ… ç›´æ¥ä»å¾®ä¿¡è·å–

// 1. å°è¯•ä» wxContext è·å– (åŸç”Ÿè°ƒç”¨)
if (openid) {
  session_key = wxContext.SESSION_KEY;  // âœ… è‡ªåŠ¨å¤„ç†
}
```

**å®‰å…¨è¯„ä¼°**:
- âœ… æ— éœ€å®ç°è‡ªå®šä¹‰ç™»å½•é€»è¾‘
- âœ… å¾®ä¿¡è‡ªåŠ¨éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… session_key ç”±å¹³å°ç®¡ç†ï¼Œå®‰å…¨å¯é 

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

#### 1.3 HTTPè§¦å‘å™¨è®¤è¯ âš ï¸ éœ€è¦æ”¹è¿›

**å‘ç°**: éƒ¨åˆ†äº‘å‡½æ•°æ”¯æŒ `_token` å‚æ•°ä½œä¸º OPENID

**ä»£ç **:
```javascript
// cloudfunctions/promotion/index.js:1752
const OPENID = requestData._token || cloud.getWXContext().OPENID || requestData.OPENID;
```

**å®‰å…¨é£é™©**:
- ğŸŸ¡ **ä¸­ç­‰é£é™©**: `_token` å‚æ•°æœªåŠ å¯†æˆ–ç­¾åéªŒè¯
- ğŸŸ¡ **ä¸­ç­‰é£é™©**: HTTPè§¦å‘å™¨å¯èƒ½è¢«ä¼ªé€ è¯·æ±‚

**å½±å“èŒƒå›´**:
- `promotion` äº‘å‡½æ•°
- `user` äº‘å‡½æ•°
- `order` äº‘å‡½æ•°
- `wallet` äº‘å‡½æ•°
- `coupon` äº‘å‡½æ•°

**ä¿®å¤å»ºè®®**:

**æ–¹æ¡ˆA**: ç§»é™¤ `_token` æ”¯æŒï¼ˆæ¨èï¼‰
```javascript
// åªä½¿ç”¨ wxContext.OPENID
const OPENID = cloud.getWXContext().OPENID;
if (!OPENID) {
  return error(ErrorCodes.NOT_LOGIN, 'æœªç™»å½•');
}
```

**æ–¹æ¡ˆB**: å®ç° JWT Token éªŒè¯
```javascript
const jwt = require('jsonwebtoken');

// éªŒè¯ _token æ˜¯å¦ä¸ºæœ‰æ•ˆ JWT
if (requestData._token) {
  try {
    const decoded = jwt.verify(requestData._token, process.env.JWT_SECRET);
    const OPENID = decoded.openid;
  } catch (error) {
    return error(ErrorCodes.INVALID_TOKEN, 'Tokenæ— æ•ˆ');
  }
}
```

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å®æ–½ï¼‰

---

### 2. è¾“å…¥éªŒè¯å®‰å…¨ âœ…

#### 2.1 é‚€è¯·ç éªŒè¯ âœ… è‰¯å¥½

**æ–‡ä»¶**: `cloudfunctions/promotion/index.js`

**éªŒè¯é€»è¾‘**:
```javascript
async function bindPromotionRelation(event, context) {
  const { parentInviteCode, mentorCode, userInfo, deviceInfo } = event;

  // âœ… å‚æ•°å­˜åœ¨æ€§æ£€æŸ¥
  if (!parentInviteCode || !userInfo) {
    return { code: -1, msg: 'å‚æ•°ä¸å®Œæ•´' };
  }

  // âœ… é‚€è¯·ç æ ¼å¼éªŒè¯
  if (parentInviteCode.length !== INVITE_CODE_LENGTH) {
    return { code: -1, msg: 'é‚€è¯·ç æ ¼å¼é”™è¯¯' };
  }
}
```

**å®‰å…¨è¯„ä¼°**:
- âœ… æ£€æŸ¥å‚æ•°å®Œæ•´æ€§
- âœ… éªŒè¯é‚€è¯·ç é•¿åº¦
- âš ï¸ **å¯æ”¹è¿›**: æœªéªŒè¯é‚€è¯·ç å­—ç¬¦é›†

**æ”¹è¿›å»ºè®®**:
```javascript
// æ·»åŠ æ­£åˆ™è¡¨è¾¾å¼éªŒè¯
const INVITE_CODE_REGEX = /^[A-HJ-NP-Z2-9]{6}$/;  // æ’é™¤ I,O,0,1

if (!INVITE_CODE_REGEX.test(parentInviteCode)) {
  return { code: -1, msg: 'é‚€è¯·ç æ ¼å¼é”™è¯¯' };
}
```

**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

---

#### 2.2 è®¢å•é‡‘é¢éªŒè¯ âœ… è‰¯å¥½

**æ–‡ä»¶**: `cloudfunctions/promotion/index.js`

**éªŒè¯é€»è¾‘**:
```javascript
async function calculatePromotionRewardV2(event, context) {
  const { orderId, buyerId, orderAmount } = event;

  // âœ… è¾¹ç•Œæ£€æŸ¥
  if (!orderAmount || orderAmount <= 0) {
    logger.warn('Invalid order amount', { amount: orderAmount });
    return { code: 0, msg: 'è®¢å•é‡‘é¢æ— æ•ˆ', data: { rewards: [] } };
  }
}
```

**å®‰å…¨è¯„ä¼°**:
- âœ… é˜²æ­¢è´Ÿæ•°æˆ–é›¶é‡‘é¢
- âœ… é˜²æ­¢ undefined/null
- âš ï¸ **å¯æ”¹è¿›**: æœªè®¾ç½®ä¸Šé™

**æ”¹è¿›å»ºè®®**:
```javascript
// æ·»åŠ é‡‘é¢ä¸Šé™æ£€æŸ¥
const MAX_ORDER_AMOUNT = 100000000;  // 100ä¸‡

if (orderAmount > MAX_ORDER_AMOUNT) {
  logger.warn('Order amount exceeds limit', { amount: orderAmount });
  return { code: -1, msg: 'è®¢å•é‡‘é¢è¶…å‡ºé™åˆ¶' };
}
```

**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½ï¼ˆä¸šåŠ¡é€»è¾‘é™åˆ¶ï¼Œéå®‰å…¨é—®é¢˜ï¼‰

---

#### 2.3 SQL/NoSQLæ³¨å…¥é˜²æŠ¤ âœ… è‰¯å¥½

**å‘ç°**: ä½¿ç”¨ CloudBase SDK å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå¤©ç„¶é˜²æ³¨å…¥

**ä»£ç ç¤ºä¾‹**:
```javascript
// âœ… å®‰å…¨ï¼šä½¿ç”¨ where() å‚æ•°åŒ–æŸ¥è¯¢
const userRes = await db.collection('users')
  .where({ _openid: OPENID })  // å‚æ•°åŒ–ï¼Œä¸ä¼šæ³¨å…¥
  .get();

// âœ… å®‰å…¨ï¼šä½¿ç”¨ _.in() æ“ä½œç¬¦
.where({ _openid: _.in(parentChain) })
```

**å®‰å…¨è¯„ä¼°**:
- âœ… CloudBase SDK è‡ªåŠ¨å¤„ç†å‚æ•°è½¬ä¹‰
- âœ… æ— åŸå§‹ SQL/NoSQL æŸ¥è¯¢å­—ç¬¦ä¸²
- âœ… ä½¿ç”¨æ“ä½œç¬¦è€Œéå­—ç¬¦ä¸²æ‹¼æ¥

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

### 3. é˜²åˆ·æœºåˆ¶ âœ…

#### 3.1 IPé™åˆ¶ âœ… å·²å®ç°

**æ–‡ä»¶**: `cloudfunctions/promotion/index.js:161-221`

**å®ç°**:
```javascript
async function checkDuplicateRegistration(openid, deviceInfo) {
  const recentTime = new Date(Date.now() - IP_LIMIT_WINDOW);

  // 1. æ£€æŸ¥åŒä¸€IPçš„æ³¨å†Œæ¬¡æ•°
  const recentRegs = await db.collection('registration_attempts')
    .where({
      ip: deviceInfo.ip,
      timestamp: _.gte(recentTime)
    })
    .count();

  if (recentRegs.total >= MAX_REGISTRATIONS_PER_IP) {
    return {
      valid: false,
      reason: 'è¯¥IPåœ°å€æ³¨å†Œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
    };
  }
}
```

**é…ç½®**:
```javascript
const AntiFraud = {
  MAX_REGISTRATIONS_PER_IP: 3,        // åŒIP 24å°æ—¶å†…æœ€å¤š3æ¬¡
  IP_LIMIT_WINDOW_HOURS: 24,         // 24å°æ—¶çª—å£
  REGISTRATION_ATTEMPT_TTL_DAYS: 7   // è®°å½•ä¿ç•™7å¤©
};
```

**å®‰å…¨è¯„ä¼°**:
- âœ… é˜²æ­¢åŒä¸€IPæ‰¹é‡æ³¨å†Œ
- âœ… æ—¶é—´çª—å£é™åˆ¶åˆç†
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•

**å±€é™æ€§**:
- ğŸŸ¡ **ä¸­ç­‰é£é™©**: æ— æ³•é˜²æ­¢ä»£ç†IP/VPN
- ğŸŸ¡ **ä¸­ç­‰é£é™©**: NATç¯å¢ƒä¸‹å¤šç”¨æˆ·å…±äº«IP

**æ”¹è¿›å»ºè®®**:
```javascript
// å¢åŠ è®¾å¤‡æŒ‡çº¹è¯†åˆ«
async function checkDuplicateRegistration(openid, deviceInfo) {
  // 1. æ£€æŸ¥ OPENID é‡å¤
  const existingUser = await db.collection('users')
    .where({ _openid: openid })
    .get();

  if (existingUser.data.length > 0) {
    return { valid: false, reason: 'ç”¨æˆ·å·²æ³¨å†Œ' };
  }

  // 2. æ£€æŸ¥ IP é™åˆ¶ï¼ˆç°æœ‰é€»è¾‘ï¼‰
  // ...

  // 3. æ£€æŸ¥è®¾å¤‡IDï¼ˆæ–°å¢ï¼‰
  if (deviceInfo.deviceId) {
    const deviceRegs = await db.collection('registration_attempts')
      .where({
        deviceId: deviceInfo.deviceId,
        timestamp: _.gte(recentTime)
      })
      .count();

    if (deviceRegs.total >= MAX_REGISTRATIONS_PER_IP) {
      return { valid: false, reason: 'è¯¥è®¾å¤‡æ³¨å†Œè¿‡äºé¢‘ç¹' };
    }
  }
}
```

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå»ºè®®å¢å¼ºï¼‰

---

#### 3.2 é‚€è¯·ç å”¯ä¸€æ€§ âœ… å·²å®ç°

**æ–‡ä»¶**: `cloudfunctions/promotion/index.js:122-131`

**å®ç°**:
```javascript
function generateInviteCode() {
  const chars = AntiFraud.INVITE_CODE_CHARS;  // æ’é™¤ I, O, 0, 1
  let code = '';
  for (let i = 0; i < INVITE_CODE_LENGTH; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// å¸¦é‡è¯•æœºåˆ¶çš„é‚€è¯·ç ç”Ÿæˆ
async function createUniqueInviteCode(maxRetries = INVITE_CODE_MAX_RETRY) {
  for (let i = 0; i < maxRetries; i++) {
    const code = generateInviteCode();
    const existing = await db.collection('users').where({ inviteCode: code }).get();
    if (existing.data.length === 0) return code;
  }
  throw new Error('æ— æ³•ç”Ÿæˆå”¯ä¸€é‚€è¯·ç ');
}
```

**å®‰å…¨è¯„ä¼°**:
- âœ… æ’é™¤æ˜“æ··æ·†å­—ç¬¦ï¼ˆI, O, 0, 1ï¼‰
- âœ… é‡è¯•æœºåˆ¶é˜²æ­¢ç¢°æ’
- âœ… æ•°æ®åº“å”¯ä¸€æ€§çº¦æŸ

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

### 4. æ•°æ®åº“å®‰å…¨ ğŸŸ¡

#### 4.1 æ•°æ®åº“æƒé™é…ç½® âŒ ç¼ºå¤±

**å‘ç°**: æœªæ‰¾åˆ°æ•°æ®åº“å®‰å…¨è§„åˆ™é…ç½®æ–‡ä»¶

**ç¼ºå¤±æ–‡ä»¶**:
- `database.rules.json` (NoSQL å®‰å…¨è§„åˆ™)
- æ•°æ®åº“æƒé™é…ç½®æ–‡æ¡£

**å®‰å…¨é£é™©**:
- ğŸ”´ **é«˜é£é™©**: ä»»ä½•äººéƒ½å¯ä»¥è¯»å†™æ•°æ®åº“é›†åˆ
- ğŸ”´ **é«˜é£é™©**: ç”¨æˆ·å¯ä»¥ä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ•°æ®
- ğŸ”´ **é«˜é£é™©**: æ•æ„Ÿæ•°æ®å¯èƒ½è¢«æ³„éœ²

**ä¿®å¤å»ºè®®**:

**åˆ›å»º `database.rules.json`**:
```json
{
  "rules": {
    "users": {
      ".read": "auth.openid == doc._openid || auth.openid == doc.parentId",
      ".write": "auth.openid == doc._openid || auth.openid == 'admin-openid'",
      ".update": {
        "agentLevel": "auth.openid == doc._openid && newData.agentLevel >= oldData.agentLevel",
        "starLevel": "auth.openid == doc._openid && newData.starLevel >= oldData.starLevel"
      }
    },
    "reward_records": {
      ".read": "auth.openid == doc.beneficiaryId",
      ".write": false  // åªèƒ½é€šè¿‡äº‘å‡½æ•°åˆ›å»º
    },
    "promotion_orders": {
      ".read": "auth.openid == doc.buyerId || auth.openid == doc.promoterId",
      ".write": false  // åªèƒ½é€šè¿‡äº‘å‡½æ•°åˆ›å»º
    },
    "registration_attempts": {
      ".read": false,
      ".write": false  // åªèƒ½é€šè¿‡äº‘å‡½æ•°åˆ›å»º
    }
  }
}
```

**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ï¼ˆå¿…é¡»é…ç½®ï¼‰

---

#### 4.2 äº‹åŠ¡ä½¿ç”¨ âœ… è‰¯å¥½

**å‘ç°**: å…³é”®æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡

**ä»£ç **:
```javascript
// V2ä½£é‡‘è®¡ç®—ä½¿ç”¨äº‹åŠ¡
async function calculatePromotionRewardV2(event, context) {
  const transaction = await db.startTransaction();

  try {
    // 1. åˆ›å»ºå¥–åŠ±è®°å½•
    await createRewardRecord({...}, transaction);

    // 2. è®°å½•æ¨å¹¿è®¢å•
    await transaction.collection('promotion_orders').add({...});

    // 3. æ›´æ–°ä¹°å®¶è®¢å•è®¡æ•°
    await updateBuyerOrderCount(buyerId, transaction);

    // æäº¤äº‹åŠ¡
    await transaction.commit();
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

**å®‰å…¨è¯„ä¼°**:
- âœ… é˜²æ­¢æ•°æ®ä¸ä¸€è‡´
- âœ… åŸå­æ€§æ“ä½œä¿è¯
- âœ… é”™è¯¯æ—¶å›æ»š

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

### 5. APIå®‰å…¨ âœ…

#### 5.1 äº‘å‡½æ•°éš”ç¦» âœ… è‰¯å¥½

**æ¶æ„**: æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨äº‘å‡½æ•°ä¸­æ‰§è¡Œï¼Œå‰ç«¯æ— æ³•ç›´æ¥è®¿é—®æ•°æ®åº“

**å®‰å…¨ä¼˜åŠ¿**:
- âœ… æ•°æ®åº“ä¸ç›´æ¥æš´éœ²
- âœ… ä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
- âœ… å¯ä»¥å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

#### 5.2 é”™è¯¯å¤„ç† âœ… è‰¯å¥½

**å‘ç°**: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

**ä»£ç **:
```javascript
// cloudfunctions/promotion/common/response.js
const error = (code, message, details) => {
  return {
    code: code < 0 ? code : -1,
    msg: message || 'æ“ä½œå¤±è´¥',
    data: null
  };
};
```

**å®‰å…¨è¯„ä¼°**:
- âœ… ä¸æš´éœ²å†…éƒ¨é”™è¯¯è¯¦æƒ…
- âœ… ç»Ÿä¸€çš„é”™è¯¯ç 
- âœ… é¿å…ä¿¡æ¯æ³„éœ²

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

### 6. æ—¥å¿—å’Œå®¡è®¡ âœ…

#### 6.1 æ•æ„Ÿä¿¡æ¯è„±æ• âœ… è‰¯å¥½

**æ–‡ä»¶**: `cloudfunctions/promotion/common/logger.js`

**å®ç°**:
```javascript
const logger = createLogger('promotion');

// âœ… æ•æ„Ÿä¿¡æ¯ä¸è®°å½•åˆ°æ—¥å¿—
logger.info('Wallet action', { action });  // ä¸è®°å½• OPENID
logger.info('Anti-fraud check initiated', { ip: deviceInfo.ip });  // è„±æ• IP
```

**å®‰å…¨è¯„ä¼°**:
- âœ… ä¸è®°å½• OPENID
- âœ… ä¸è®°å½•å®Œæ•´æ‰‹æœºå·
- âœ… ä¸è®°å½•æ”¯ä»˜ä¿¡æ¯

**ä¼˜å…ˆçº§**: æ— éœ€ä¿®æ”¹

---

#### 6.2 æ“ä½œæ—¥å¿— âš ï¸ éœ€è¦å®Œå–„

**å‘ç°**: ç¼ºå°‘å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—

**ç¼ºå¤±é¡¹**:
- å‡çº§æ“ä½œå®¡è®¡
- ä½£é‡‘è®¡ç®—å®¡è®¡
- æ•æ„Ÿæ•°æ®ä¿®æ”¹å®¡è®¡

**æ”¹è¿›å»ºè®®**:

**åˆ›å»ºæ“ä½œæ—¥å¿—é›†åˆ**:
```javascript
async function logOperation(action, userId, details) {
  await db.collection('operation_logs').add({
    data: {
      action,
      userId,
      details,
      timestamp: db.serverDate(),
      ipAddress: cloud.getWXContext().CLIENTIP || 'unknown'
    }
  });
}

// ä½¿ç”¨ç¤ºä¾‹
await logOperation('agent_level_promotion', OPENID, {
  from: oldLevel,
  to: newLevel,
  followUpdates: followUpdates.length
});
```

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå»ºè®®å®æ–½ï¼‰

---

## å®‰å…¨é£é™©è¯„ä¼°çŸ©é˜µ

| é£é™©ç±»åˆ« | é£é™©é¡¹ | ä¸¥é‡æ€§ | å¯èƒ½æ€§ | é£é™©ç­‰çº§ | ä¼˜å…ˆçº§ |
|----------|--------|--------|--------|----------|--------|
| è®¤è¯ | HTTPè§¦å‘å™¨TokenæœªéªŒè¯ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | P1 |
| æ•°æ®åº“ | ç¼ºå°‘æ•°æ®åº“æƒé™è§„åˆ™ | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | P0 |
| é˜²åˆ· | æ— æ³•é˜²æ­¢ä»£ç†IP | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | P2 |
| æ—¥å¿— | ç¼ºå°‘æ“ä½œå®¡è®¡æ—¥å¿— | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | P2 |
| è¾“å…¥ | é‚€è¯·ç æœªéªŒè¯å­—ç¬¦é›† | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | P3 |

---

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ P0 - å¿…é¡»ç«‹å³ä¿®å¤ï¼ˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼‰

**1. é…ç½®æ•°æ®åº“å®‰å…¨è§„åˆ™**

**é—®é¢˜**: ä»»ä½•äººéƒ½å¯ä»¥è¯»å†™æ•°æ®åº“

**ä¿®å¤**:
- åˆ›å»º `database.rules.json`
- é…ç½®è¯»å†™æƒé™
- åœ¨äº‘å¼€å‘æ§åˆ¶å°ä¸Šä¼ è§„åˆ™

**é¢„è®¡å·¥ä½œé‡**: 2å°æ—¶

---

### ğŸŸ¡ P1 - å¼ºçƒˆå»ºè®®ä¿®å¤ï¼ˆéƒ¨ç½²å1å‘¨å†…ï¼‰

**2. ç§»é™¤æˆ–åŠ å¯† _token å‚æ•°**

**é—®é¢˜**: HTTPè§¦å‘å™¨è®¤è¯ä¸å®‰å…¨

**ä¿®å¤**: ç§»é™¤ `_token` æ”¯æŒï¼Œåªä½¿ç”¨ `wxContext.OPENID`

**é¢„è®¡å·¥ä½œé‡**: 1å°æ—¶

---

**3. å¢å¼ºè®¾å¤‡æŒ‡çº¹è¯†åˆ«**

**é—®é¢˜**: é˜²åˆ·æœºåˆ¶å¯è¢«ç»•è¿‡

**ä¿®å¤**: å¢åŠ è®¾å¤‡IDã€ç”¨æˆ·ä»£ç†ç­‰æŒ‡çº¹

**é¢„è®¡å·¥ä½œé‡**: 3å°æ—¶

---

### ğŸŸ¢ P2 - å»ºè®®ä¼˜åŒ–ï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰

**4. å®Œå–„æ“ä½œå®¡è®¡æ—¥å¿—**

**é—®é¢˜**: ç¼ºå°‘å®Œæ•´çš„æ“ä½œå®¡è®¡

**ä¿®å¤**: è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ

**é¢„è®¡å·¥ä½œé‡**: 4å°æ—¶

---

### ğŸŸ¢ P3 - å¯é€‰ä¼˜åŒ–

**5. å¢å¼ºè¾“å…¥éªŒè¯**

**é—®é¢˜**: é‚€è¯·ç æœªéªŒè¯å­—ç¬¦é›†

**ä¿®å¤**: æ·»åŠ æ­£åˆ™è¡¨è¾¾å¼éªŒè¯

**é¢„è®¡å·¥ä½œé‡**: 1å°æ—¶

---

## å®‰å…¨æœ€ä½³å®è·µå»ºè®®

### 1. å¼€å‘ç¯å¢ƒ

- âœ… ä½¿ç”¨äº‘å‡½æ•°ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥
- âœ… ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- âœ… ä½¿ç”¨ `.env.local` æ–‡ä»¶ç®¡ç†æœ¬åœ°é…ç½®

### 2. ç”Ÿäº§ç¯å¢ƒ

- ğŸ”´ **å¿…é¡»**: é…ç½®æ•°æ®åº“å®‰å…¨è§„åˆ™
- ğŸ”´ **å¿…é¡»**: å¯ç”¨äº‘å‡½æ•°è®¿é—®æ—¥å¿—
- ğŸ”´ **å¿…é¡»**: å®šæœŸå¤‡ä»½æ ¸å¿ƒæ•°æ®
- ğŸŸ¡ **å»ºè®®**: é…ç½®äº‘å‡½æ•°è®¿é—®é¢‘ç‡é™åˆ¶
- ğŸŸ¡ **å»ºè®®**: å¯ç”¨äº‘å‡½æ•°å¯†é’¥è®¤è¯

### 3. ç›‘æ§å’Œå‘Šè­¦

- ğŸŸ¡ **å»ºè®®**: é…ç½®å¼‚å¸¸ç™»å½•å‘Šè­¦
- ğŸŸ¡ **å»ºè®®**: ç›‘æ§äº‘å‡½æ•°é”™è¯¯ç‡
- ğŸŸ¡ **å»ºè®®**: è®¾ç½®æ•°æ®åº“æ“ä½œé¢‘ç‡å‘Šè­¦
- ğŸŸ¡ **å»ºè®®**: å®šæœŸå®¡æŸ¥å®‰å…¨æ—¥å¿—

---

## åˆè§„æ€§æ£€æŸ¥

### å¾®ä¿¡å°ç¨‹åºå®‰å…¨è§„èŒƒ

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| ç”¨æˆ·ä¿¡æ¯æ”¶é›† | âœ… ç¬¦åˆ | åªæ”¶é›†å¿…è¦ä¿¡æ¯ |
| æ•æ„Ÿä¿¡æ¯å­˜å‚¨ | âœ… ç¬¦åˆ | ä¸å­˜å‚¨æ•æ„Ÿä¿¡æ¯ |
| æ•°æ®ä¼ è¾“åŠ å¯† | âœ… ç¬¦åˆ | ä½¿ç”¨HTTPS |
| ç¬¬ä¸‰æ–¹æœåŠ¡ | âœ… ç¬¦åˆ | åªä½¿ç”¨è…¾è®¯äº‘æœåŠ¡ |
| éšç§æ”¿ç­– | âš ï¸ å¾…ç¡®è®¤ | éœ€ç¡®è®¤éšç§æ”¿ç­–æ˜¯å¦æ›´æ–° |

### ç­‰ä¿2.0è¦æ±‚ï¼ˆå¦‚é€‚ç”¨ï¼‰

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| èº«ä»½é‰´åˆ« | âœ… ç¬¦åˆ | ä½¿ç”¨å¾®ä¿¡OPENID |
| è®¿é—®æ§åˆ¶ | ğŸŸ¡ éƒ¨åˆ†ç¬¦åˆ | éœ€é…ç½®æ•°æ®åº“è§„åˆ™ |
| å®‰å…¨å®¡è®¡ | ğŸŸ¡ éƒ¨åˆ†ç¬¦åˆ | éœ€å®Œå–„æ“ä½œæ—¥å¿— |
| æ•°æ®å®Œæ•´æ€§ | âœ… ç¬¦åˆ | ä½¿ç”¨äº‹åŠ¡ä¿è¯ |
| æ•°æ®ä¿å¯†æ€§ | âœ… ç¬¦åˆ | æ•æ„Ÿä¿¡æ¯è„±æ• |

---

## æµ‹è¯•å»ºè®®

### å®‰å…¨æµ‹è¯•æ¸…å•

- [ ] æµ‹è¯•æœªæˆæƒè®¿é—®ï¼ˆå°è¯•ç›´æ¥è®¿é—®æ•°æ®åº“ï¼‰
- [ ] æµ‹è¯•æ³¨å…¥æ”»å‡»ï¼ˆSQL/NoSQLæ³¨å…¥ï¼‰
- [ ] æµ‹è¯•XSSæ”»å‡»ï¼ˆå¦‚æœ‰å¯Œæ–‡æœ¬è¾“å…¥ï¼‰
- [ ] æµ‹è¯•CSRFæ”»å‡»ï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰
- [ ] æµ‹è¯•æš´åŠ›ç ´è§£ï¼ˆIPé™åˆ¶æ˜¯å¦ç”Ÿæ•ˆï¼‰
- [ ] æµ‹è¯•ä¼šè¯åŠ«æŒï¼ˆOPENIDæ˜¯å¦å¯ä¼ªé€ ï¼‰
- [ ] æµ‹è¯•ä¸šåŠ¡é€»è¾‘ç»•è¿‡ï¼ˆä½£é‡‘è®¡ç®—æ˜¯å¦å¯ç¯¡æ”¹ï¼‰

### æ¸—é€æµ‹è¯•å»ºè®®

å»ºè®®è˜è¯·ç¬¬ä¸‰æ–¹å®‰å…¨å…¬å¸è¿›è¡Œæ¸—é€æµ‹è¯•ï¼Œé‡ç‚¹æµ‹è¯•ï¼š
- æ¨å¹¿ç³»ç»Ÿå®‰å…¨æ€§
- æ”¯ä»˜æµç¨‹å®‰å…¨æ€§
- ç”¨æˆ·æ•°æ®ä¿æŠ¤
- APIæ¥å£å®‰å…¨

---

## æ€»ç»“

### å½“å‰çŠ¶æ€

æ¨å¹¿ç³»ç»ŸV2åœ¨å®‰å…¨æ€§æ–¹é¢æ€»ä½“è¡¨ç°**è‰¯å¥½**ï¼Œä¸»è¦ä¼˜ç‚¹ï¼š

âœ… **ä¼˜ç‚¹**:
1. æ­£ç¡®ä½¿ç”¨å¾®ä¿¡ OPENID è®¤è¯
2. å®ç°äº†å¤šå±‚é˜²åˆ·æœºåˆ¶
3. ä½¿ç”¨äº‘å‡½æ•°éš”ç¦»ä¸šåŠ¡é€»è¾‘
4. å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. æ•æ„Ÿä¿¡æ¯å·²è„±æ•å¤„ç†

âš ï¸ **éœ€è¦æ”¹è¿›**:
1. ğŸ”´ **å¿…é¡»é…ç½®æ•°æ®åº“å®‰å…¨è§„åˆ™**ï¼ˆP0ï¼‰
2. ğŸŸ¡ ç§»é™¤æˆ–åŠ å¯† _token å‚æ•°ï¼ˆP1ï¼‰
3. ğŸŸ¡ å¢å¼ºè®¾å¤‡æŒ‡çº¹è¯†åˆ«ï¼ˆP1ï¼‰
4. ğŸŸ¡ å®Œå–„æ“ä½œå®¡è®¡æ—¥å¿—ï¼ˆP2ï¼‰

### éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] é…ç½®æ•°æ®åº“å®‰å…¨è§„åˆ™ï¼ˆ`database.rules.json`ï¼‰
- [ ] ç§»é™¤æˆ–åŠ å¯† HTTPè§¦å‘å™¨ _token å‚æ•°
- [ ] å¯ç”¨äº‘å‡½æ•°è®¿é—®æ—¥å¿—
- [ ] é…ç½®äº‘å‡½æ•°å¯†é’¥è®¤è¯ï¼ˆå¯é€‰ï¼‰
- [ ] è¿›è¡Œå®‰å…¨æµ‹è¯•
- [ ] æ›´æ–°éšç§æ”¿ç­–ï¼ˆå¦‚éœ€è¦ï¼‰

### é•¿æœŸç»´æŠ¤è®¡åˆ’

1. **å®šæœŸå®‰å…¨å®¡æŸ¥**ï¼ˆæ¯å­£åº¦ï¼‰
2. **ç›‘æ§å®‰å…¨æ—¥å¿—**ï¼ˆæ¯æ—¥ï¼‰
3. **æ›´æ–°ä¾èµ–åŒ…**ï¼ˆæ¯æœˆï¼‰
4. **è¿›è¡Œæ¸—é€æµ‹è¯•**ï¼ˆæ¯å¹´ï¼‰
5. **å…³æ³¨å®‰å…¨å…¬å‘Š**ï¼ˆæŒç»­ï¼‰

---

**å®¡æŸ¥äººå‘˜**: Claude Sonnet 4.6
**æœ€åæ›´æ–°**: 2026-02-25
**ç‰ˆæœ¬**: 1.0
