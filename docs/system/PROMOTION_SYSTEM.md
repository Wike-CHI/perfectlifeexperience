# 大友元气精酿啤酒 - 阶级跃迁分销体系技术白皮书

## 1. 体系概述

本分销体系采用 **"星级身份 + 代理层级" 双轨制** 设计，旨在通过实时激励和阶级跃迁机制，打破传统分销的阶层固化，激活代理团队的裂变动力。系统基于云开发 (CloudBase) 的 Serverless 架构，实现了毫秒级的业绩计算与即时晋升。

## 2. 核心机制设计

### 2.1 双轨制身份体系

每个推广员拥有两套并行的身份标签：

| 维度 | 字段名 | 定义 | 作用 |
|------|--------|------|------|
| **代理层级** | `agentLevel` | 纵向职级 (4级 -> 1级) | 决定**基础佣金**比例 (5% - 20%) |
| **星级身份** | `starLevel` | 横向荣誉 (普通 -> 金牌) | 决定**额外权益** (复购奖/管理奖/育成奖) |

**层级定义：**
*   **0级 (总公司)**: 系统保留，获得订单金额的 80% 作为公司利润。
*   **1级 (一级代理)**: 最高代理等级，享受 10% 基础佣金。
*   **2级 (二级代理)**: 享受 6% 基础佣金。
*   **3级 (三级代理)**: 享受 3% 基础佣金。
*   **4级 (四级代理)**: 初始等级，享受 1% 基础佣金。

**星级定义：**
*   **0 (普通)**: 初始状态。
*   **1 (铜牌)**: 享受 3% 复购奖。
*   **2 (银牌)**: 享受 2% 团队管理奖。
*   **3 (金牌)**: 享受 1.5% 隔代分润（预留）。

### 2.2 混合分润算法

每一笔订单成交后，系统会并行计算以下四重收益：

**订单收益分配（总计 100%）:**

1.  **总公司利润 (80%)**
    *   每笔订单的 80% 归总公司所有，不参与佣金分配。

2.  **代理佣金池 (20%)**
    *   **基础佣金**: 根据上级代理的 `agentLevel` 确定比例。
        *   比例: 1级(10%) > 2级(6%) > 3级(3%) > 4级(1%)。
        *   逻辑: 按距离由近及远匹配，总和为 20%。

    *   **复购奖励 (Repurchase)**
        *   条件: 订单为"复购单"（买家历史订单数 > 0）且上级 `starLevel >= 1` (铜牌)。
        *   比例: **3%**（从代理佣金池中扣除）。
        *   目的: 激励代理维护老客户，建立资产性收益。

    *   **团队管理奖 (Management)**
        *   条件: 上级 `starLevel >= 2` (银牌)。
        *   比例: **2%**（从代理佣金池中扣除），采用**级差制**。
        *   逻辑: 上级所得 = 2% - 下级已拿的管理奖比例。避免奖金拨比溢出。

    *   **育成津贴 (Nurture)**
        *   条件: 受益人存在绑定关系的导师 (`mentorId`)。
        *   比例: **2%**（从代理佣金池中扣除）。
        *   目的: 解决"下级晋升后上级没钱拿"的零和博弈，鼓励上级培养下级。

### 2.3 即时晋升引擎

系统不再依赖月度结算，而是基于**实时业绩**触发晋升判断：

*   **数据源**: `users.performance` 对象，包含 `totalSales`(累计)、`monthSales`(本月)、`directCount`(直推数)。
*   **晋升铜牌 (Star 0 -> 1)**:
    *   条件: 累计销售额 ≥ 20,000元 **或** 直推有效人数 ≥ 30人。
    *   触发: 订单结算后立即生效。
*   **晋升银牌 (Star 1 -> 2)**:
    *   条件: 本月销售额 ≥ 50,000元 **或** 团队人数 ≥ 50人。
    *   触发: 订单结算后立即生效。
*   **跨月重置**:
    *   系统在每次更新业绩前检查 `monthTag`。
    *   若发现月份变更，自动重置 `monthSales` 为 0，确保月度考核准确性。

## 3. 技术实现细节

### 3.1 数据库模型 (`PromotionUser`)

```typescript
interface PromotionUser {
  // ...
  starLevel: 0 | 1 | 2 | 3;
  agentLevel: 0 | 1 | 2 | 3 | 4;
  performance: {
    totalSales: number;    // 历史累计销售额 (单位: 分)
    monthSales: number;    // 本月销售额 (单位: 分)
    monthTag: string;      // 跨月标识, 如 "2023-10"
    directCount: number;   // 直推有效人数
  };
  mentorId?: string;       // 育成导师ID
}
```

### 3.2 关键云函数 (`calculatePromotionReward`)

位于 `cloudfunctions/promotion/index.js`，核心流程：
1.  **Context Loading**: 批量拉取上级链条用户数据。
2.  **Hybrid Calculation**: 内存中并行计算 Commission, Repurchase, Management, Nurture 四种奖励。
3.  **Atomic Update**: 使用 `db.command.inc` 原子更新上级业绩，防止并发写入丢失。
4.  **Instant Check**: 业绩更新后立即比对晋升门槛，满足条件即刻 `update({ starLevel: x })`。

### 3.3 前端可视化

*   **身份徽章**: 推广中心头部展示当前的代理等级和星级徽章。
*   **晋升进度条**: 智能计算距离下一级的差额（金额或人数），并以进度条形式展示，提供强烈的目标感。
*   **收益明细**: 收益记录精确标记来源类型（如“复购奖励”、“团队管理奖”），让代理清晰感知每一分钱的构成。

## 4. 收益分配示例

假设订单金额为 **1000元**，推广链为：四级代理 → 三级代理 → 二级代理 → 一级代理

**订单收益分配：**
- **总公司**: 800元 (80%)
- **代理佣金池**: 200元 (20%)

**代理佣金池分配（200元）：**
- **四级代理**: 基础佣金 10元 (1%)
- **三级代理**: 基础佣金 30元 (3%)
- **二级代理**: 基础佣金 60元 (6%) + 复购奖 30元 (3%) = 90元
- **一级代理**: 基础佣金 100元 (10%) + 管理奖 20元 (2%) = 120元

**实际发放**: 10 + 30 + 90 + 120 = 250元

**注意**: 由于复购奖、管理奖等额外奖励从20%代理佣金池中扣除，实际发放的总佣金可能超过20%，需要根据订单情况动态调整。

## 5. 运营建议

1.  **去分销化文案**: 前端已将"分销"字眼弱化，建议运营中多使用"推广员"、"体验官"、"合伙人"等称呼。
2.  **拨比监控**: 虽然系统有级差保护，但建议定期通过 `reward_records` 分析总拨比（Total Payout Ratio），确保代理佣金池（20%）加上其他奖励后的总支出在可控范围内。
3.  **佣金池管理**: 注意监控代理佣金池的使用情况，当多个奖励同时触发时（复购+管理+育成），总佣金可能超过20%，需要设置兜底机制。
4.  **跳级通道**: 目前实现了"四级 -> 二级"的底层逻辑支持，未来可配合运营活动开放"连续金牌直接跳级"的自动处理逻辑。
