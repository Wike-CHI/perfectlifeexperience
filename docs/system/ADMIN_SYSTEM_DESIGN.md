# 大友元气精酿啤酒 - 后台管理系统设计文档

## 1. 系统概述

本系统为「大友元气」精酿啤酒商城的后台管理端，旨在为运营人员、财务人员和系统管理员提供全方位的业务管理能力。系统基于腾讯云开发（CloudBase）架构，与小程序端共享底层数据和云函数服务，确保数据的一致性和实时性。

### 1.1 建设目标
- **业务闭环**：实现从商品上架、订单处理到物流发货的全流程管理。
- **分销管控**：提供分销代理体系的审核、监控与业绩结算管理。
- **数据洞察**：可视化展示销售数据、用户增长和分销裂变情况。
- **营销赋能**：灵活配置优惠券、限时特惠等营销活动。

### 1.2 适用角色
- **超级管理员**：拥有系统所有权限。
- **运营专员**：负责商品、订单、营销活动和内容管理。
- **财务专员**：负责提现审核、资金对账和报表查看。
- **客服专员**：负责订单查询、售后处理和用户咨询。

---

## 2. 技术架构

### 2.1 技术栈建议
鉴于管理后台主要在 PC 端操作，且需要复杂的表单和数据展示，建议采用主流的 Web 管理端技术栈：

- **前端框架**：Vue 3 + TypeScript
- **构建工具**：Vite
- **UI 组件库**：Element Plus 或 Ant Design Vue
- **云开发 SDK**：@cloudbase/js-sdk (Web端)
- **图表库**：ECharts (用于数据可视化)

> **注意**：虽然项目中包含 `admin_dash` (UniApp 模板)，但考虑到 PC 端管理后台的复杂交互（如富文本编辑、复杂表格、多图上传），原生 Web 方案通常比 UniApp 编译的 H5 体验更佳。但若需同时支持移动端管理，可继续基于 `admin_dash` 开发。

### 2.2 数据交互
- **鉴权**：使用云开发自定义登录或账号密码登录，结合 RBAC（基于角色的访问控制）模型。
- **数据源**：直接连接云数据库（Cloud Database），复用小程序端的集合（Collections）。
- **业务逻辑**：复用现有的云函数（Cloud Functions），如 `promotion`、`rewardSettlement` 等，必要时新增管理端专用云函数。

---

## 3. 功能模块设计

### 3.1 控制台 (Dashboard)
**核心指标可视化**：
- **实时数据**：今日订单数、今日销售额、今日新增用户、今日新增代理。
- **待办事项**：待发货订单、待审核提现、库存预警。
- **趋势图表**：近7日/30日销售额趋势、用户增长趋势、Top 10 畅销商品。

### 3.2 商品管理 (Product)
对应集合：`products`, `categories`

| 功能点 | 描述 | 关联字段/逻辑 |
| :--- | :--- | :--- |
| **商品列表** | 分页展示，支持按名称、分类、状态筛选。支持批量上下架、删除。 | `isHot`, `isNew` |
| **新增/编辑商品** | 录入商品基础信息、多规格（SKU）设置、价格库存、富文本详情。 | `specs`, `prices` (Array), `detail` (HTML) |
| **分类管理** | 管理商品分类（如：鲜啤外带、增味啤），设置排序和图标。 | `category` |
| **库存管理** | 查看和调整各规格库存。 | SKU 库存字段 |

### 3.3 订单管理 (Order)
对应集合：`orders`

| 功能点 | 描述 | 关联字段/逻辑 |
| :--- | :--- | :--- |
| **订单列表** | 全量订单查询，支持按订单号、手机号、状态、时间范围筛选。 | `orderNo`, `status` |
| **订单详情** | 查看收货信息、商品清单、费用明细、支付流水、物流信息、订单日志。 | `address`, `items`, `payAmount` |
| **发货处理** | 对“待发货”订单录入物流公司和单号，触发发货状态流转。 | `status: 'shipped'`, `shipTime` |
| **售后/退款** | 处理用户的退款申请，执行仅退款或退货退款流程。 | 需新增售后状态字段 |
| **订单导出** | 导出订单数据为 Excel，用于财务核算或第三方发货系统。 | - |

### 3.4 用户管理 (User)
对应集合：`users`

| 功能点 | 描述 | 关联字段/逻辑 |
| :--- | :--- | :--- |
| **用户列表** | 展示所有注册用户，支持按昵称、手机号搜索。 | `nickName`, `phone` |
| **用户详情** | 查看用户画像、收货地址簿、历史订单、钱包余额、优惠券持有情况。 | 关联 `orders`, `user_coupons` |
| **标签管理** | 给用户打标签（如：高价值、易投诉），用于精细化运营。 | `tags` |
| **余额调整** | (高权限) 手动调整用户钱包余额，需记录操作日志。 | 调用 `wallet` 云函数 |

### 3.5 分销管理 (Promotion)
对应集合：`promotion_users`, `reward_records`

| 功能点 | 描述 | 关联字段/逻辑 |
| :--- | :--- | :--- |
| **代理列表** | 查看推广员名单，展示等级、星级、直推人数、团队人数、累计业绩。 | `agentLevel`, `starLevel`, `performance` |
| **代理审核** | (如需) 审核用户的代理申请。 | - |
| **关系树查询** | 输入用户ID，图形化展示其上下级关系链（族谱树）。 | `mentorId` |
| **佣金明细** | 查询所有分销奖励记录，支持按类型（基础、复购、管理、育成）筛选。 | `rewardType` |
| **等级配置** | 配置各等级的佣金比例、晋升门槛（全局配置）。 | 存入 `config` 集合 |

### 3.6 营销中心 (Marketing)
对应集合：`coupon_templates`, `banners`

| 功能点 | 描述 | 关联字段/逻辑 |
| :--- | :--- | :--- |
| **优惠券管理** | 创建/编辑优惠券模板（满减、折扣、无门槛），设置发行量和有效期。 | `CouponTemplate` 模型 |
| **领券记录** | 查看优惠券的领取和核销情况。 | `user_coupons` |
| **轮播图配置** | 管理首页 Banner，设置图片、跳转链接、排序。 | `banners` 集合 |
| **限时特惠** | 配置秒杀/特惠活动，关联商品和活动时间。 | `promo` 集合 |

### 3.7 财务管理 (Finance)
对应集合：`wallet_transactions`, `withdrawals`

| 功能点 | 描述 | 关联字段/逻辑 |
| :--- | :--- | :--- |
| **充值记录** | 查看用户的余额充值流水。 | `type: 'recharge'` |
| **提现审核** | 审核用户的佣金/余额提现申请，支持打款（微信企业付款或线下）。 | `withdrawals` 集合 |
| **资金对账** | 平台资金流水总览，收入（订单）与支出（提现、退款）统计。 | - |

### 3.8 系统设置 (System)
| 功能点 | 描述 |
| :--- | :--- |
| **账号权限** | 管理后台登录账号，分配角色（超级管理员、运营、财务）。 |
| **基础配置** | 设置运费模板、客服联系方式、隐私协议/用户协议内容。 |
| **操作日志** | 记录管理员的关键操作（如修改价格、发货、调整余额），便于追溯。 |

---

## 4. 数据库集合规划 (Collections)

除了小程序已有的集合外，建议补充以下集合以支持后台管理：

1.  **`admins`**: 后台管理员表
    *   `username`, `password` (加密), `role`, `lastLogin`
2.  **`configs`**: 全局配置表
    *   `key` (如 'freight_rule'), `value`
3.  **`operation_logs`**: 操作日志表
    *   `adminId`, `action`, `targetId`, `detail`, `ip`, `time`
4.  **`withdrawals`**: 提现申请表
    *   `userId`, `amount`, `status` (pending/approved/rejected), `accountInfo`, `auditTime`

---

## 5. 接口与安全

### 5.1 接口规范
后台管理系统应通过云开发 SDK 或 HTTP API 调用后端服务。
- **读取数据**：大部分列表和详情可直接使用 SDK 的 `db.collection().get()`，需配置安全规则允许管理员读写。
- **写操作**：敏感操作（如修改余额、审核）必须通过云函数执行，云函数内部校验管理员权限。

### 5.2 权限控制 (Security)
- **云数据库权限**：
    - 小程序端用户：仅能读写自己的数据 (`auth.openid == _openid`)，公开数据（商品）只读。
    - 管理员：拥有所有集合的读写权限（通过自定义登录态或管理端 SDK 密钥）。
- **敏感数据脱敏**：
    - 列表页展示手机号时进行脱敏处理（如 138****1234），详情页点击“查看”并记录日志后才显示明文。

---

## 6. 开发建议

1.  **优先实现商品和订单模块**，这是业务跑通的基础。
2.  **复用云函数**：例如 `promotion` 云函数中的结算逻辑，后台不需要重写，只需调用查询接口。
3.  **利用 CloudBase CMS**：腾讯云开发提供了 headless CMS 扩展，对于简单的“轮播图管理”、“公告管理”甚至“商品管理”，可以直接安装使用，极大减少开发工作量。
4.  **分阶段交付**：
    - Phase 1: 商品管理、订单处理、基础用户查看。
    - Phase 2: 分销审核与查询、财务提现。
    - Phase 3: 数据大屏、精细化营销配置。
